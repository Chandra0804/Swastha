import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import javafx.event.ActionEvent;
import javafx.fxml.FXMLLoader;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.Alert;
import javafx.stage.Stage;

public class DBUtilities {

    public void changeScene(ActionEvent event , String fxmlfile) throws IOException{
        Parent root = null;
        FXMLLoader loader = new FXMLLoader(DBUtilities.class.getResource(fxmlfile));
        root = loader.load();
        Stage stage = (Stage) ((Node) event.getSource()).getScene().getWindow();
    }

    public static void Create_Appointment(Appointment_ID app)
    {
        Connection con = null;
        PreparedStatement psInsert = null;
        ResultSet rs = null;

        try {
            con = DriverManager.getConnection("jdbc:mysql://localhost:3306/swastha", "root","Srilekha@05");

            psInsert = con.prepareStatement("insert into Appointment values(?,?,?,?,?)");
            psInsert.setString(1, app.getAppointmentID());
            psInsert.setString(2,app.getTime());
            psInsert.setString(3, app.getDate());
            psInsert.setString(4, app.getDocter_email());
            psInsert.setString(5, app.getPatient_email());

        } catch (Exception e) {
            System.err.println(e);
        }finally{
            if(rs != null)
            {
                try{
                    rs.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
            if(psInsert!=null)
            {
                try{
                    psInsert.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
            if(con!=null)
            {
                try{
                    con.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
        }

    }

    public static void Cancel_Appointment(Appointment_ID app)
    {
        Connection con = null;
        PreparedStatement psDelete = null;
        PreparedStatement psCheckAppointmentExists = null;
        ResultSet rs = null;

        try {
            con = DriverManager.getConnection("jdbc:mysql://localhost:3306/swastha", "root","Srilekha@05");
            psCheckAppointmentExists = con.prepareStatement("select * from Appointment where AppointmentID = ?");
            psCheckAppointmentExists.setString(1, app.getAppointmentID());
            rs = psCheckAppointmentExists.executeQuery();

            if(rs.isBeforeFirst())
            {
                psDelete = con.prepareStatement("delete from Appointment where AppointmentID = ?");
                psDelete.setString(1,app.getAppointmentID());
                psDelete.executeQuery();
            }
            else{
                Alert alert = new Alert(Alert.AlertType.ERROR);
                alert.setContentText("No Appointment found to delete with given Appointment ID ");
                alert.show();
            }

        } catch (Exception e) {
            System.err.println(e);
        }finally{
            if(rs != null)
            {
                try{
                    rs.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
            if(psCheckAppointmentExists != null)
            {
                try{
                    psCheckAppointmentExists.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
            if(psDelete != null)
            {
                try{
                    psDelete.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
           
            if(con!=null)
            {
                try{
                    con.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
        }

    }


    public static void Search_Appointment(Appointment_ID app)
    {
        Connection con = null;
        PreparedStatement psCheckAppointmentExists = null;
        ResultSet rs = null;

        try {
            con = DriverManager.getConnection("jdbc:mysql://localhost:3306/swastha", "root","Srilekha@05");
            psCheckAppointmentExists = con.prepareStatement("select * from Appointment where AppointmentID = ?");
            psCheckAppointmentExists.setString(1, app.getAppointmentID());
            rs = psCheckAppointmentExists.executeQuery();

            if(rs.isBeforeFirst()){
                changeScene(event,"ShowAppointments");
            }
            else{
                Alert alert = new Alert(Alert.AlertType.ERROR);
                alert.setContentText("No Appointments found");
                alert.show();
            }

        } catch (Exception e) {
            System.err.println(e);
        }finally{
            if(rs != null)
            {
                try{
                    rs.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
            if(psCheckAppointmentExists != null)
            {
                try{
                    psCheckAppointmentExists.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
            
            if(con!=null)
            {
                try{
                    con.close();
                }
                catch(Exception e)
                {
                    System.err.println(e);
                }
            }
        }

    }
}
